# 7. 데이터 암호화

### 독서 중 궁금해지는 내용
- MySQL 8.0으로 업그레이드 되면서 데이터 파일 뿐 아니라 리두로그, 언두로그, 복제를 위한 바이너리 로그 등도 모두 암호화 기능 지원
- MySQL 서버의 암호화 기능은 데이터베이스 서버와 디스크 사이의 I/O 지점에서 암호화 또는 복호화를 수행함 
    - 그 외에서 암호화가 되었는지 식별할 필요가 없는 암호화 방식을 TDE(Transparent Data Encryption) 이라고 함
    - MySQL의 TDE에서 암호화 키는 키링(KeyRing) 플러그인에 의해 관리
- 키링 플러그인은 2단계 키 관리 방식을 사용하며 MySQL TDE 지원 암호화 알고리즘은 AES-256
    - 마스터 키 : 외부 키 관리 솔루션에서 마스터키를 가져옴
    - 테이블 스페이스 키 : 프라이빗 키라고도 불리며 암호화된 테이블이 생성될 때마다 해당 키 발급
    - 마스터키를 이용해 테이블 스페이스 키를 암호화하여 각 테이블의 데이터 파일 헤더에 저장. 이렇게 생성된 테이블스페이스 키는 테이블이 삭제되지 않는한 절대 변경되지 않음
- 서버와 복제된 레플리카 서버는 각자 다른 마스터키를 할당함
- 응용 프로그램에서 직접 암호화하면 MySQL은 이것이 암호화된 여부를 인지하지 못함
    - JPA를 사용해서 db에 직접 암호화/복호화 하는 방법이 있을까..?
- TDE가 적용되어 암호화된 테이블을 복사나 이동해야할 경우 마스터 키가 다르므로 FLUSH TABLES 명령으로 익스포트할 수 있음
- 디스크로 저장되는 데이터만 암호화되므로 메모리에 존재하는 데이터는 평문으로 관리되며 그로인해 리두로그, 언두로그, 바이너리 로그에는 평문으로 저장됨
    - 리두로그나 언두로그는 평문으로 저장하다 시스템 변수를 사용하여 암호화를 활성화하면 그때부터 생성되는 리두로그나 언두로그만 암호화 하여 저장
- 바이너리 로그와 릴레이 로그는 의도적으로 상당히 긴 시간 동안 보관하는 서비스도 있고 때로는 증분 백업을 위해 보관하므로 바이너리 로그 파일 암호화는 상황에 따라 중요도가 높아질 수도 있음
- 바이너리 로그와 릴레이 로그는 디스크에 저장된 로그파일에 대한 암호화만 담당

<br>

## 연습문제

### 1. 리두로그, 언두로그, 바이너리 로그는 어떻게 암호화가 이루어지는가?

<details>
<summary>정답</summary>

#### 리두로그, 언두로그 암호화
- MySQL 설정 파일에서 관련 설정을 구성
- 해당 시스템 변수를 사용하여 암호화를 활성화하면 그때부터 생성되는 리두로그나 언두로그만 암호화하여 저장
- 테이블스페이스가 디스크에 저장될 때 수행됨
- 리두 로그와 언두 로그는 주로 InnoDB 테이블스페이스의 일부로 취급되며, 테이블스페이스 암호화가 활성화된 경우 암호화
    - 이는 로그 데이터뿐만 아니라 관련 테이블 데이터도 암호화됨을 의미

```mysql
innodb_redo_log_encrypt=ON
innodb_undo_log_encrypt=ON
```

<br>

### 바이너리 로그 암호화
- MySQL 서버의 설정 파일을 통해 설정
- 바이너리 로그와 릴레이 로그는 의도적으로 상당히 긴 시간 동안 보관하는 서비스도 있고 때로는 증분 백업을 위해 보관하므로 바이너리 로그 파일 암호화는 상황에 따라 중요도가 높아질 수도 있음
- 로그 파일이 디스크에 저장될 때 수행
    - 이는 로그 파일이 디스크에 평문으로 저장되지 않도록 하여 물리적인 데이터 유출을 방지

```mysql
binlog_encryption=ON
```


</details>