# ë°©ì¤˜ í”„ë¡œì íŠ¸ ( 25.03.10 ~ 25.04.10 )

## 1. í”„ë¡œì íŠ¸ ì†Œê°œ (í˜„ì¬ ì‘ì„± ì¤‘)
- 'ë°©ì¤˜' í”„ë¡œì íŠ¸ëŠ” ì›”ì„¸ë¥¼ ì €ë ´í•˜ê²Œ êµ¬í•˜ê³  ì‹¶ì€ ì²­ë…„ë“¤ì„ íƒ€ê²Ÿìœ¼ë¡œ í•œ ì„œë¹„ìŠ¤ë¡œ ê³µì¸ì¤‘ê³„ì‚¬ ì—†ì´ ì›”ì„¸ ê±°ë˜ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
- ë“±ê¸°ë¶€ ë“±ë³¸ ì •ë³´ë¥¼ í†µí•´ ì„ëŒ€ ê±´ë¬¼ì— ëŒ€í•œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìœ„í—˜ë„ ë¶„ì„ ë° ì„ëŒ€ì¸ê³¼ ì„ì°¨ì¸ì˜ ê±°ë˜ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ê³„ì•½ì„œë¥¼ ì‘ì„± ë° ì‘ì„± ë³´ì¡° ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
- BE 4ëª…, FE 2ëª…ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ì§„í–‰í•˜ì˜€ìœ¼ë©° ì €ëŠ” ë§¤ë¬¼ ê¸°ëŠ¥ ë° ê²°ì œ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ì˜€ìŠµë‹ˆë‹¤.


<br>

### 1-1. ë‹´ë‹¹ ì„œë¹„ìŠ¤ ë„ë©”ì¸

ğŸ“‘ ë§¤ë¬¼ ê¸°ëŠ¥
- ë§¤ë¬¼ ë“±ë¡ ë° ì¡°íšŒ
- ì§‘ì£¼ì¸ ì¸ì¦
- í¬íŠ¸ì› ë³¸ì¸ ì¸ì¦
- ë“±ê¸°ë¶€ ìœ„í—˜ë„ ë¶„ì„

ğŸ“‘ ê²°ì œ ê¸°ëŠ¥
- í¬íŠ¸ì› ê¸ˆì•¡ ê²°ì œ
- ê²°ì œ ë‚´ì—­ ì¡°íšŒ

<br><br>

### 1-2. ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜



<br>


<br><br>


### 1-3. ë‚´ê°€ ì‚¬ìš©í•œ ê¸°ìˆ  ìŠ¤íƒ

#### âœ… BE
- Java, SpringBoot, JPA, Swagger

#### âœ… DB
- MySQL, Redis

<br><br>


## 2. í˜‘ì—… ì§„í–‰ ë°©ì‹

<br>

### 2-1. Jira í˜‘ì—… íˆ´ ì‚¬ìš©


- Jira ìŠ¤í”„ë¦°íŠ¸ ì§„í–‰

<br>

### 2-2. Figma ì™€ì´ì–´í”„ë ˆì„

![wireframe](./img/figma.png)

- figmaë¥¼ ì‚¬ìš©í•œ ì™€ì´ì–´í”„ë ˆì„ ì‘ì„±

<br>

### 2-3. Notion ëª…ì„¸ ë° ë¬¸ì„œí™”

![Notion1](./img/notion.png)

<br>

![ìš”êµ¬ì‚¬í•­ ëª…ì„¸ì„œ](./img/ìš”êµ¬ì‚¬í•­ëª…ì„¸ì„œ.png)

<br>

![API ëª…ì„¸ì„œ](./img/APIëª…ì„¸ì„œ.png)

<br>

![postman](./img/postman.png)

- ìš”êµ¬ì‚¬í•­ ëª…ì„¸ì„œ, API ëª…ì„¸ì„œ ë…¸ì…˜ìœ¼ë¡œ ì‘ì„±
- API í…ŒìŠ¤íŠ¸ëŠ” PostMan ì‚¬ìš©

<br>

### 2-4. ERD ì„¤ê³„

![erd](./img/erd.png)

- ERD-Cloud ë¥¼ ì‚¬ìš©í•œ ERD ì„¤ê³„

<br>

### 2-5. GitLab MergeRequest


<br><br>

## 3. í”„ë¡œì íŠ¸ êµ¬í˜„ ì‚¬í•­

<br>

## 4. í”„ë¡œì íŠ¸ ì§„í–‰ ì¤‘ ì´ìŠˆ ì‚¬í•­

```java
// ì‘ë‹µ ë°˜í™˜ì„ ìœ„í•œ í˜ì´ì§€ë„¤ì´ì…˜ ê³µí†µ ëª¨ë“ˆ ë¶„ë¦¬
@Getter
@JsonPropertyOrder({"totalItems", "totalPages", "currentPage", "size", "currentPageItemCount", "offset", "items"})
public class PageResponse<T> {
	private static final int DEFAULT_SIZE = 15;

	private final int totalItems;
	private final int totalPages;
	private final int currentPage;
	private final int size;
	private final int currentPageItemCount;
	private final List<T> items;


	public PageResponse(int totalItems, Integer currentPage, Integer size, List<T> items) {
		int cp = (currentPage == null || currentPage <= 0) ? 1 : currentPage;
		int s = (size == null || size <= 0) ? DEFAULT_SIZE : size;
		this.totalItems = totalItems;
		this.currentPage = cp;
		this.size = s;
		this.currentPageItemCount = (items == null) ? 0 : items.size();
		this.totalPages = (totalItems == 0) ? 0 : (int)Math.ceil((double)totalItems / s);
		this.items = items;
	}

	public PageResponse(int totalItems, Integer currentPage, List<T> items) {
		this(totalItems, currentPage, DEFAULT_SIZE, items);
	}

	public int getOffset() {
		return (currentPage - 1) * size + 1;
	}
}

// Page ê°ì²´ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•œ, Pageable ê°ì²´ ìƒì„± í´ë˜ìŠ¤
public class PaginationRequest {
	private static final int DEFAULT_SIZE = 15;

	public static Pageable toPageable(Integer page, Integer size) {
		int currentPage = (page == null || page < 1) ? 1 : page;
		int pageSize = (size == null || size < 1) ? DEFAULT_SIZE : size;

		return PageRequest.of(currentPage - 1, pageSize);
	}

	public static Pageable toPageable(Integer page) {
		int currentPage = (page == null || page < 1) ? 1 : page;
		
		return PageRequest.of(currentPage - 1, DEFAULT_SIZE);
	}
}

// ì¡°íšŒë¥¼ ìœ„í•œ ë§¤ë¬¼ ë ˆí¬ì§€í† ë¦¬ë¡œ Pageable ê°ì²´ë¥¼ ì‚¬ìš©í•´ Pageì— í•´ë‹¹í•˜ëŠ” ì—”í‹°í‹°ë§Œ í˜ì´ì§€ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜
@Repository
public interface RoomRepository extends JpaRepository<Room, Long> {
	Optional<Room> findByRoomIdAndDeletedAtIsNull(Long roomId);

	Page<Room> findAllByMemberId(Long memberId, Pageable pageable);

	List<Room> findByRoomIdIn(List<Long> roomIds);

	Page<Room> findAll(Specification<Room> spec, Pageable pageable);
}
```

<br>

### 4-1. ë§¤ë¬¼ ì¡°íšŒ ì¤‘ í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ ë¶„ë¦¬
- ê¸°ì¡´ ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì¡°íšŒ í›„ í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë¥¼ í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ë³€í™˜í–ˆë˜ ê³¼ì •ì„ í˜ì´ì§€ë„¤ì´ì…˜ ê°ì²´ë¥¼ ë¯¸ë¦¬ ìƒì„± í›„ JPA íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ë³€ê²½
- ê¸°ì¡´ ë¡œì§ì€ ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ì¡°íšŒí•˜ê³  í˜ì´ì§€ë„¤ì´ì…˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ Nê°œì˜ ì—”í‹°í‹°ë“¤ì„ ëª¨ë‘ ì¡°íšŒ
- í˜„ì¬ ë¡œì§ì€ ìš”ì²­ë˜ëŠ” í˜ì´ì§€ì— í•´ë‹¹ë˜ëŠ” ì—”í‹°í‹°ë§Œì„ ì¡°íšŒ

<br>

```sql
Hibernate: 
    /* <criteria> */ select
        r1_0.room_id,
        r1_0.available_from,
        r1_0.bathroom_cnt,
        r1_0.building_type,
        ...
    from
        room r1_0 
    where
        r1_0.member_id=? 
    limit   /* Pageable ê°ì²´ë§Œí¼ë§Œ ì¡°íšŒ */
        ?
```

- ë³€ê²½ëœ sql í˜ì´ì§€ë„¤ì´ì…˜ ì¡°íšŒ ê²°ê³¼

<br>

```sql
Hibernate: 
    /* <criteria> */ select
        r1_0.room_id,
        r1_0.available_from,
        r1_0.bathroom_cnt,
        ...
    from
        room r1_0 
    where
        r1_0.monthly_rent<=? 
        and (
            r1_0.exclusive_area between ? and ? 
            or r1_0.exclusive_area between ? and ? 
            or r1_0.exclusive_area between ? and ?
        ) 
        and r1_0.room_id in ((select
            a1_0.room_id 
        from
            address a1_0 
        where
            a1_0.lat between ? and ? 
            and a1_0.lng between ? and ?)) 
    limit
        ?, ?
Hibernate: 
    /* <criteria> */ select
        l1_0.like_id,
        l1_0.flag,
        ...
    from
        likes l1_0 
    where
        l1_0.room_id=? 
        and l1_0.member_id=?
Hibernate: 
    /* <criteria> */ select
        i1_0.image_id,
        i1_0.created_at,
        ...
    from
        image i1_0 
    where
        i1_0.room_id=? 
    order by
        i1_0.room_id desc 
    limit
        ?
Hibernate: 
    /* <criteria> */ select
        l1_0.like_id,
        l1_0.flag,
        ...
    from
        likes l1_0 
    where
        l1_0.room_id=? 
        and l1_0.member_id=?
Hibernate: 
    /* <criteria> */ select
        i1_0.image_id,
        i1_0.created_at,
        ...
    from
        image i1_0 
    where
        i1_0.room_id=? 
    order by
        i1_0.room_id desc 
    limit
        ?
Hibernate: 
    /* <criteria> */ select
        l1_0.like_id,
        l1_0.flag,
        ...
    from
        likes l1_0 
    where
        l1_0.room_id=? 
        and l1_0.member_id=?
Hibernate: 
    /* <criteria> */ select
        i1_0.image_id,
        i1_0.created_at,
        ...
    from
        image i1_0 
    where
        i1_0.room_id=? 
    order by
        i1_0.room_id desc 
    limit
        ?
    ...
```

### 4-2. ë§¤ë¬¼ ì¡°íšŒ ì‹œ N + 1 ë¬¸ì œ ë°œìƒ
- í˜„ì¬ Pageë¡œ ìƒì„±í•œ ROOM ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì¡°íšŒí•˜ê³  ê° ROOM ì—”í‹°í‹° ë§ˆë‹¤ LIKES, IMAGE í…Œì´ë¸”ì´ Në²ˆ ì”© ì¶”ê°€ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë¨
    - í˜„ì¬ í˜ì´ì§€ë„¤ì´ì…˜ì„ í†µí•´ ì´ page size * 3 ë²ˆ ë§Œí¼ ë°˜ë³µë˜ê³  ìˆìŒ ( 3N )
- í˜„ì¬ êµ¬ì„±ì€ ROOM ì—”í‹°í‹°ë¥¼ ì¡°íšŒ ì´í›„ LIKES, IMAGE ì—”í‹°í‹° ë‚´ë¶€ì— ROOMì´ ìˆê³ , í•´ë‹¹ ROOMìœ¼ë¡œ LazyLoading ì¡°íšŒë¥¼ í†µí•´ N + 2N ì¡°íšŒë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•¨

<br>

### í˜„ì¬ ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ

```java
@Entity
@Table(name = "ADDRESS") // ...
public class Address {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long addressId;

    // í˜„ì¬ ë‹¨ë°©í–¥ìœ¼ë¡œ êµ¬ì„±
	@ManyToOne(fetch = FetchType.LAZY)  // ì—°ê´€ê´€ê³„ê°€ Lazyë¡œ ë˜ì–´ìˆì–´ ì‹¤ì œ ì‚¬ìš© ì‹œì ì— ê°ê° ë³„ë„ì˜ ì¡°íšŒ ë°œìƒ
	@JoinColumn(name = "room_id", nullable = false)
	private Room room;
    
    // ...
}

@Entity
@Table(name = "IMAGE") // ...
public class Image extends BaseEntity {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long imageId;

    // í˜„ì¬ ë‹¨ë°©í–¥ìœ¼ë¡œ êµ¬ì„±
	@ManyToOne(fetch = FetchType.LAZY)  // ì—°ê´€ê´€ê³„ê°€ Lazyë¡œ ë˜ì–´ìˆì–´ ì‹¤ì œ ì‚¬ìš© ì‹œì ì— ê°ê° ë³„ë„ì˜ ì¡°íšŒ ë°œìƒ
	@JoinColumn(name = "room_id", nullable = false)
	private Room room;
    // ...
}

// RoomService searchRooms() ë©”ì„œë“œ
Pageable pageable = PaginationRequest.toPageable(page);
Page<Room> roomPage = roomRepository.findAll(spec, pageable);   // Room Në²ˆ ì¡°íšŒ

List<RoomSummaryResponse> roomSummaryList = roomPage.getContent().stream()
    .map(room -> {
        boolean liked = likeRepository.findByRoomIdAndMemberId(room.getRoomId(), memberId)  // Room í•˜ë‚˜ë§ˆë‹¤ Like ì¡°íšŒ
            .map(Likes::getFlag)
            .orElse(false);
        String imageUrl = imageService.findMainImageByRoom(room).getImageUrl(); // Room í•˜ë‚˜ë§ˆë‹¤ Image ì¡°íšŒ
        return RoomConverter.convertToRoomSummary(room, liked, imageUrl);
    })
    .collect(Collectors.toList());
```

### ë¬¸ì œ í•´ê²° ë°©ì‹
- ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ì²«ë²ˆì§¸ ë°©ì‹ì€ Room ì„ Në²ˆ ì¡°íšŒí•œ í›„ í•´ë‹¹ ì—”í‹°í‹°ë“¤ì˜ RoomIdë¥¼ ì¶”ì¶œí•˜ì—¬ ë‹¤ë¥¸ ë¦¬ìŠ¤íŠ¸ë¡œ ëª¨ìœ¼ê³  í•´ë‹¹ RoomId ë¦¬ìŠ¤íŠ¸ë¥¼ In ì ˆìœ¼ë¡œ ë°°ì¹˜ ì¡°íšŒ
- ë‘ë²ˆì§¸ ë°©ì‹ì€ Fetch Join ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ Roomê³¼ ì—°ê´€ëœ Likes, Images ì—”í‹°í‹°ë¥¼ í•œ ë²ˆì— ì¡°íšŒ
    - í•˜ì§€ë§Œ í˜ì´ì§•ê³¼ Fetch Joinì„ í•¨ê»˜ ì‚¬ìš©ì‹œ ê²°ê³¼ í–‰ì´ ì¤‘ë³µë˜ì–´ í˜ì´ì§• ê³„ì‚°ì— ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì–´ DISTINCT ì‚¬ìš© í•„ìš”

<br>

## 5. í™”ë©´ êµ¬ì„±

<br>

