# ë°©ì¤˜ í”„ë¡œì íŠ¸ ( 25.03.10 ~ 25.04.10 )

![ë©”ì¸ í˜ì´ì§€](./img/main-page.png)

<br>

## 1. í”„ë¡œì íŠ¸ ì†Œê°œ
- 'ë°©ì¤˜' í”„ë¡œì íŠ¸ëŠ” ì›”ì„¸ë¥¼ ì €ë ´í•˜ê²Œ êµ¬í•˜ê³  ì‹¶ì€ ì²­ë…„ë“¤ì„ íƒ€ê²Ÿìœ¼ë¡œ í•œ ì„œë¹„ìŠ¤ë¡œ ê³µì¸ì¤‘ê³„ì‚¬ ì—†ì´ ì›”ì„¸ ê±°ë˜ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
- ë“±ê¸°ë¶€ ë“±ë³¸ ì •ë³´ë¥¼ í†µí•´ ì„ëŒ€ ê±´ë¬¼ì— ëŒ€í•œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìœ„í—˜ë„ ë¶„ì„ ë° ì„ëŒ€ì¸ê³¼ ì„ì°¨ì¸ì˜ ê±°ë˜ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ê³„ì•½ì„œë¥¼ ì‘ì„± ë° ì‘ì„± ë³´ì¡° ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
- BE 4ëª…, FE 2ëª…ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ì§„í–‰í•˜ì˜€ìœ¼ë©° ì €ëŠ” ë¡œê·¸ì¸ ë° íšŒì› ê¸°ëŠ¥, ë§¤ë¬¼ ê¸°ëŠ¥ ë° ê³„ì•½ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ì˜€ìŠµë‹ˆë‹¤.


<br>

### 1-1. ë‹´ë‹¹ ì„œë¹„ìŠ¤ ë„ë©”ì¸

ğŸ“‘ íšŒì› ê¸°ëŠ¥
- ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸
- íšŒì›ê°€ì…, íšŒì› ì •ë³´ ìˆ˜ì •/ì¡°íšŒ
- ë§ˆì´í˜ì´ì§€ ì¡°íšŒ (ë§¤ë¬¼/ê³„ì•½/ê²°ì œ ë‚´ì—­ ë“±)
- í¬íŠ¸ì› ë³¸ì¸ì¸ì¦

ğŸ“‘ ë§¤ë¬¼ ê¸°ëŠ¥
- ë§¤ë¬¼ ë“±ë¡/ í•„í„°ë§ ì¡°íšŒ
- ì¹´ì¹´ì˜¤ ì¥ì†Œ API ë§¤ë¬¼ ì£¼ì†Œ ì¡°íšŒ

ğŸ“‘ ê³„ì•½ ê¸°ëŠ¥
- ê³„ì•½ì„œ ìƒì„±/ìˆ˜ì •/ì¡°íšŒ
- í¬íŠ¸ì› ê²°ì œ ë° ë‚´ì—­ ì¡°íšŒ

<br><br>

### 1-2. ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜

![ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜](./img/architecture.png)


<br><br>


### 1-3. ë‚´ê°€ ì‚¬ìš©í•œ ê¸°ìˆ  ìŠ¤íƒ

#### âœ… BE
- Java, SpringBoot, JPA, Oauth2, Webflux, AWS S3, Swagger

#### âœ… DB
- MySQL, MongoDB, Redis

<br><br>


## 2. í˜‘ì—… ì§„í–‰ ë°©ì‹

<br>

### 2-1. Jira í˜‘ì—… íˆ´ ì‚¬ìš©

![jira](./img/jira.png)

- Jira ìŠ¤í”„ë¦°íŠ¸ ì´ìŠˆ í•´ê²°

<br>

### 2-2. Figma ì™€ì´ì–´í”„ë ˆì„

![wireframe](./img/figma.png)

- figmaë¥¼ ì‚¬ìš©í•œ ì™€ì´ì–´í”„ë ˆì„ ì‘ì„±

<br>

### 2-3. Notion ëª…ì„¸ ë° ë¬¸ì„œí™”

![Notion1](./img/notion.png)

<br>

![ìš”êµ¬ì‚¬í•­ ëª…ì„¸ì„œ](./img/ìš”êµ¬ì‚¬í•­ëª…ì„¸ì„œ.png)

<br>

![API ëª…ì„¸ì„œ](./img/APIëª…ì„¸ì„œ.png)

<br>

![postman](./img/postman.png)

<br>

![ìŠ¤ì›¨ê±° ë¬¸ì„œí™”](./img/swagger.png)

<br>

![ìŠ¤ì›¨ê±° ë¬¸ì„œí™”2](./img/swagger2.png)

- ìš”êµ¬ì‚¬í•­ ëª…ì„¸ì„œ, API ëª…ì„¸ì„œ ë…¸ì…˜ìœ¼ë¡œ ì‘ì„±
- API í…ŒìŠ¤íŠ¸ëŠ” PostMan, Swagger ì‚¬ìš©

<br>

### 2-4. ERD ì„¤ê³„

![erd](./img/erd.png)

- ERD-Cloud ë¥¼ ì‚¬ìš©í•œ ERD ì„¤ê³„

<br><br>

## 3. ì½”ë“œ ë¦¬íŒ©í† ë§

#### 3-1. í˜ì´ì§€ë„¤ì´ì…˜ ê³µí†µ ëª¨ë“ˆ ë¶„ë¦¬
- ê¸°ì¡´ ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì¡°íšŒ í›„ í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë¥¼ í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ë³€í™˜í–ˆë˜ ê³¼ì •ì„ í˜ì´ì§€ë„¤ì´ì…˜ ê°ì²´ë¥¼ ë¯¸ë¦¬ ìƒì„± í›„ JPA íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ë³€ê²½
- ê¸°ì¡´ ë¡œì§ì€ ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ì¡°íšŒí•˜ê³  í˜ì´ì§€ë„¤ì´ì…˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ Nê°œì˜ ì—”í‹°í‹°ë“¤ì„ ëª¨ë‘ ì¡°íšŒ
- í˜„ì¬ ë¡œì§ì€ ìš”ì²­ë˜ëŠ” í˜ì´ì§€ì— í•´ë‹¹ë˜ëŠ” ì—”í‹°í‹°ë§Œì„ ì¡°íšŒ

```java
// ì‘ë‹µ ë°˜í™˜ì„ ìœ„í•œ í˜ì´ì§€ë„¤ì´ì…˜ ê³µí†µ ëª¨ë“ˆ ë¶„ë¦¬
@Getter
@JsonPropertyOrder({"totalItems", "totalPages", "currentPage", "size", "currentPageItemCount", "offset", "items"})
public class PageResponse<T> {
	private static final int DEFAULT_SIZE = 15;

	private final int totalItems;
	private final int totalPages;
	private final int currentPage;
	private final int size;
	private final int currentPageItemCount;
	private final List<T> items;


	public PageResponse(int totalItems, Integer currentPage, Integer size, List<T> items) {
		int cp = (currentPage == null || currentPage <= 0) ? 1 : currentPage;
		int s = (size == null || size <= 0) ? DEFAULT_SIZE : size;
		this.totalItems = totalItems;
		this.currentPage = cp;
		this.size = s;
		this.currentPageItemCount = (items == null) ? 0 : items.size();
		this.totalPages = (totalItems == 0) ? 0 : (int)Math.ceil((double)totalItems / s);
		this.items = items;
	}

	public PageResponse(int totalItems, Integer currentPage, List<T> items) {
		this(totalItems, currentPage, DEFAULT_SIZE, items);
	}

	public int getOffset() {
		return (currentPage - 1) * size + 1;
	}
}

// Page ê°ì²´ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•œ, Pageable ê°ì²´ ìƒì„± í´ë˜ìŠ¤
public class PaginationRequest {
	private static final int DEFAULT_SIZE = 15;

	public static Pageable toPageable(Integer page, Integer size) {
		int currentPage = (page == null || page < 1) ? 1 : page;
		int pageSize = (size == null || size < 1) ? DEFAULT_SIZE : size;

		return PageRequest.of(currentPage - 1, pageSize);
	}

	public static Pageable toPageable(Integer page) {
		int currentPage = (page == null || page < 1) ? 1 : page;
		
		return PageRequest.of(currentPage - 1, DEFAULT_SIZE);
	}
}

// ì¡°íšŒë¥¼ ìœ„í•œ ë§¤ë¬¼ ë ˆí¬ì§€í† ë¦¬ë¡œ Pageable ê°ì²´ë¥¼ ì‚¬ìš©í•´ Pageì— í•´ë‹¹í•˜ëŠ” ì—”í‹°í‹°ë§Œ í˜ì´ì§€ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜
@Repository
public interface RoomRepository extends JpaRepository<Room, Long> {
	Optional<Room> findByRoomIdAndDeletedAtIsNull(Long roomId);

	Page<Room> findAllByMemberId(Long memberId, Pageable pageable);

	List<Room> findByRoomIdIn(List<Long> roomIds);

	Page<Room> findAll(Specification<Room> spec, Pageable pageable);
}
```

<br>

#### 3-2. S3 File Upload ëª¨ë“ˆ ë¶„ë¦¬

```java
// ë§¤ë¬¼ ì €ì¥ ê¸°ì¡´ ì½”ë“œ
@Service
public class RoomImageService {
	private final ImageRepository imageRepository;
	private final RoomRepository roomRepository;

	private final S3Client s3Client;

	@Value("${aws.s3.bucket}")
	private String bucketName;

	@Value("${aws.region}")
	private String awsRegion;

	public void uploadAndSaveImage(Room room, MultipartFile file) {
		try {
			String fileName = UUID.randomUUID() + "_" + file.getOriginalFilename();

			PutObjectRequest putObjectRequest = PutObjectRequest.builder()
				.bucket(bucketName)
				.key(fileName)
				.build();

			s3Client.putObject(putObjectRequest, RequestBody.fromBytes(file.getBytes()));

			String imageUrl = "https://" + bucketName + ".s3." + awsRegion + ".amazonaws.com/" + fileName;

			Room managedRoom = roomRepository.getReferenceById(room.getRoomId());

			Image image = Image.builder()
				.room(managedRoom)
				.imageUrl(imageUrl)
				.build();

			imageRepository.save(image);
		} catch (IOException e) {
			throw new BusinessException(RoomErrorCode.FAIL_IMAGE_UPLOAD);
		}
	}
}
```

#### ë¬¸ì œ ì‚¬í•­
- í•´ë‹¹ ì½”ë“œë¥¼ ì˜ ì‚¬ìš©í•˜ê³  ìˆë‹¤ê°€ ì´í›„ ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œë„ ì´ë¯¸ì§€ ì €ì¥í•˜ëŠ” ë¡œì§ì´ í•„ìš”
- S3ì— ëŒ€í•œ ì •ë³´ë¥¼ ì• ì´ˆì— ë§¤ë¬¼ ImageService ì´ ê´€ë¦¬í•˜ê³  ìˆëŠ” êµ¬ì¡°ê°€ ì˜ëª»ëœ ì„¤ê³„ë¼ê³  ìƒê°ì´ ë“¤ê²Œë˜ì—ˆìŒ
    - ì´í›„ í™•ì¥ë  ìˆ˜ ìˆì„ ë§Œí•œ ê¸°ëŠ¥ì— ëŒ€í•´ì„œ ì„¤ê³„ì—ì„œ ë¶„ë¦¬í•˜ëŠ” ìŠµê´€ì„ ë“¤ì´ë©´ ì¢‹ì„ ê²ƒ ê°™ìŒ..
- ì´í›„ ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì–´ëŒ‘í„° íŒ¨í„´ì„ ì´ìš©í•œ ì•„ë˜ ë°©ë²•ìœ¼ë¡œ ë¶„ë¦¬
    - ì¶”ìƒí™”ëœ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ êµ¬í˜„ì²´ë¥¼ ì˜ì¡´ì„± ì£¼ì…í•˜ì—¬ ì—°ê²°í•˜ëŠ” ì–´ëŒ‘í„° íŒ¨í„´ ì ìš©

```java
// ì´í›„ ê¸°ëŠ¥ì´ ì¶”ê°€ë ìˆ˜ ìˆì–´ ì¶”ìƒí™”
public interface FileUploaderPort {
	String upload(MultipartFile file, String directory, String fileName);
}

// S3 ê´€ë ¨ ë°ì´í„°ë¥¼ í•´ë‹¹ ì–´ëŒ‘í„°ê°€ ê´€ë¦¬
@Service
@RequiredArgsConstructor
public class S3FileUploaderAdapter implements FileUploaderPort {
	private final S3Client s3Client;

	@Value("${aws.s3.bucket}")
	private String bucketName;

	@Value("${aws.region}")
	private String awsRegion;

	@Override
    public String upload(MultipartFile file, String directory, String fileName) {
		try {
			String key = directory + fileName;
			PutObjectRequest putObjectRequest = PutObjectRequest.builder()
				.bucket(bucketName)
				.key(key)
				.build();

			s3Client.putObject(putObjectRequest, RequestBody.fromBytes(file.getBytes()));

			return "https://" + bucketName + ".s3." + awsRegion + ".amazonaws.com/" + key;
		} catch (IOException e) {
			throw new BusinessException(GlobalErrorCodes.FAIL_IMAGE_UPLOAD);
		}
	}
}

// ì´í›„ S3 ê´€ë ¨ ì •ë³´ëŠ” FileUploaderPort ì¸í„°í˜ì´ìŠ¤ê°€ ê´€ë¦¬
@Service
@RequiredArgsConstructor
public class RoomImageService {
    private final static String IMAGE_PATH = "rooms/"
	private final FileUploaderPort fileUploader;
	private final RoomImageRepository imageRepository;
	private final RoomRepository roomRepository;

	public void uploadAndSaveImage(Room room, MultipartFile file) {
		String fileName = UUID.randomUUID() + "_" + file.getOriginalFilename();
		String imageUrl = fileUploader.upload(file, IMAGE_PATH, fileName);
		Room managedRoom = roomRepository.getReferenceById(room.getRoomId());
		Image image = Image.builder().room(managedRoom).imageUrl(imageUrl).build();
		imageRepository.save(image);
	}
}
```

<br>

### 3-3. JWT ë¡œê·¸ì¸ API ê³µí†µ ëª¨ë“ˆ ë¶„ë¦¬

- @SecuritySchemeë¥¼ í†µí•´ Swaggerì— JWT ì¸ì¦ ìŠ¤í‚¤ë§ˆë¥¼ ë“±ë¡í•˜ê³ , @MemberHeaderë¼ëŠ” ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë“¤ì–´, ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë¡œê·¸ì¸ëœ ìœ ì €ì˜ memberIdë¥¼ ìë™ìœ¼ë¡œ ì£¼ì…
- HandlerMethodArgumentResolverë¥¼ ì‚¬ìš©í•´ JWT íŒŒì‹± ë¡œì§ì„ ê³µí†µí™”í•˜ê³ , ë¡œê·¸ì¸ ì‹œ ì¶”ê°€ì •ë³´ê°€ ì œê³µë˜ëŠ” APIê°€ ìˆì–´ ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ required ê°’ì„ í†µí•´ ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„
- Swagger ë¬¸ì„œì—ì„œëŠ” ê° APIì— @SecurityRequirement(name = "JWT")ë¥¼ ëª…ì‹œí•˜ì—¬ ë¡œê·¸ì¸ í•„ìš” APIë¥¼ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„ì´ ê°€ëŠ¥í•˜ë„ë¡ í•¨

```java
/**
 * @SecurityScheme ì• ë…¸í…Œì´ì…˜ì„ í†µí•´ Swagger ë¬¸ì„œì—ì„œ ì‚¬ìš©í•  ë³´ì•ˆ ìŠ¤í‚¤ë§ˆë¥¼ ë“±ë¡
 * name = "JWT"ë¡œ ëª…ëª…í•˜ì—¬, ì´í›„ API ë©”ì„œë“œì— @SecurityRequirement(name = "JWT")ë¥¼ ë‹¬ë©´ "JWT ì¸ì¦ì´ í•„ìš”í•œ API"ë¡œ í‘œì‹œ
 * type = SecuritySchemeType.HTTPì™€ scheme = "bearer"ëŠ” Bearer íƒ€ì…ì˜ HTTP ì¸ì¦ì„ì„ ì˜ë¯¸
 */
@Configuration
@SecurityScheme(
    name = "JWT",
    type = SecuritySchemeType.HTTP,
    scheme = "bearer",
    bearerFormat = "JWT"
)
public class SwaggerConfig {
    // Swagger ì„¤ì •ê³¼ ê´€ë ¨ëœ ì¶”ê°€ ì„¤ì •
}

/**
 * íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œì—ì„œ @Operation ë‚´ security ì†ì„±ì„ ì‚¬ìš©í•´,
 * JWT ì¸ì¦ì´ í•„ìš”í•œ APIì„ì„ Swagger ë¬¸ì„œì— ëª…ì‹œ
 *
 * @Parameter(description, example ë“±ìœ¼ë¡œ ìŠ¤ì›¨ê±° íŒŒë¼ë¯¸í„° ì •ë³´ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŒ
 * @MemberHeaderë¥¼ ì‚¬ìš©í•´ JWTì—ì„œ íŒŒì‹±ëœ memberIdê°€ ìë™ ì£¼ì…
 */
@Operation(
    summary = "ë“±ê¸°ë¶€ ë¬¸ì„œ ì¡°íšŒ ì˜ˆì‹œ",
    description = "JWT ì¸ì¦ì´ í•„ìš”í•œ API",
    security = @SecurityRequirement(name = "JWT")  // "JWT" ë³´ì•ˆ ìŠ¤í‚¤ë§ˆë¥¼ ì ìš©
)
@GetMapping("/{id}")
public ResponseEntity<RegistryDocument> getRegistryDoc(
    @Parameter(description = "ë“±ê¸°ë¶€ ë¬¸ì„œ ID", example = "67e6332b68f0cb1ff92bf31e", required = true)
    @PathVariable String id,
    @MemberHeader Long memberId  // ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ì„ í†µí•œ JWT íŒŒì‹± í›„ ìœ ì € ID ì¡°íšŒ
) {
    // ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    return ResponseEntity.ok(new RegistryDocument());
}

/**
 * ë¡œê·¸ì¸ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜.
 *
 * @Parameter(hidden = true)ë¥¼ í†µí•´ Swagger ë¬¸ì„œì—ì„œ ì´ íŒŒë¼ë¯¸í„°ê°€ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì„¤ì •
 * required()ê°€ trueì´ë©´ í† í°ì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì„ ê²½ìš° ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©°,
 * falseì¼ ê²½ìš° í† í°ì´ ì—†ì–´ë„ null ê°’ìœ¼ë¡œ ì£¼ì…
 */
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
@Parameter(hidden = true)
@Documented
public @interface MemberHeader {
    boolean required() default true;
}

/**
 * ArgumentResolverë¥¼ í™œìš©í•´ @MemberHeaderê°€ ë¶™ì€ Long íƒ€ì… íŒŒë¼ë¯¸í„°ì— ëŒ€í•œ
 * JWT íŒŒì‹± ë¡œì§ì„ ê³µí†µí™”
 *
 * 1) í—¤ë” ê²€ì¦: Authorization í—¤ë”ê°€ ë¹„ì–´ìˆê±°ë‚˜ Bearer ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ì˜ˆì™¸(ë˜ëŠ” null)
 * 2) í† í° íŒŒì‹±: 'Bearer ' ì œê±° í›„ JwtTokenProviderë¡œ ì‹¤ì œ íŒŒì‹± ë° ê²€ì¦
 * 3) í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ memberIdê°€ ìˆ«ìë¡œ ë³€í™˜ ë¶ˆê°€ ì‹œ ì˜ˆì™¸ ë°œìƒ
 * 4) ì„±ê³µ ì‹œ, ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œ íŒŒë¼ë¯¸í„°ì— memberId(Long) ì£¼ì…
 */
@RequiredArgsConstructor
public class MemberHeaderArgumentResolver implements HandlerMethodArgumentResolver {
    private final JwtTokenProvider jwtTokenProvider;

    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        // @MemberHeader ì• ë…¸í…Œì´ì…˜ì´ ë‹¬ë¦¬ê³ , íƒ€ì…ì´ Longì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
        return parameter.hasParameterAnnotation(MemberHeader.class)
            && parameter.getParameterType().equals(Long.class);
    }

    @Override
    public Object resolveArgument(
        MethodParameter parameter,
        ModelAndViewContainer mavContainer,
        NativeWebRequest webRequest,
        WebDataBinderFactory binderFactory
    ) throws Exception {
        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);
        String authorizationHeader = request.getHeader("Authorization");

        MemberHeader memberHeader = parameter.getParameterAnnotation(MemberHeader.class);

        // 1) í† í° ìœ ë¬´ ë° Bearer í˜•ì‹ í™•ì¸
        if (authorizationHeader == null || !authorizationHeader.startsWith("Bearer ")) {
            // required=falseì¸ ê²½ìš° í† í°ì´ ì—†ì–´ë„ nullì„ ë°˜í™˜
            if (!memberHeader.required()) {
                return null;
            } else {
                // required=trueì¸ë° í† í°ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ëœ ê²½ìš° ì˜ˆì™¸
                throw new BusinessException(AuthErrorCode.NOT_EXIST_AUTHORIZATION_TOKEN);
            }
        }

        // 2) 'Bearer ' ë¶€ë¶„ ì œê±° í›„ ì‹¤ì œ í† í° ë¬¸ìì—´ ì¶”ì¶œ
        String token = authorizationHeader.substring(7);

        // 3) í† í° íŒŒì‹± ë° memberId ì¶”ì¶œ
        String memberIdStr = jwtTokenProvider.getClaims(token);

        // 4) ìˆ«ì ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸
        try {
            return Long.valueOf(memberIdStr);
        } catch (NumberFormatException e) {
            throw new BusinessException(AuthErrorCode.INVALID_AUTHORIZATION_TOKEN);
        }
    }
}
```

<br><br>

### 4. íŠ¸ëŸ¬ë¸” ìŠˆíŒ…

### 4-1. ë‹¨ë°©í–¥ ì—°ê´€ê´€ê³„ JPQL ì½”ë“œ ìˆ˜ì • ê³ ë¯¼
- ë‹¨ê±´ ì¡°íšŒì—ì„œ ë§¤ë¬¼(Room)ì— ê´€ë ¨ëœ ê°ì²´ë¥¼ ë°›ì•„ì˜¤ê³  ê°ê°ì˜ Repositoryì—ì„œ ì¡°íšŒí•˜ê³  ìˆëŠ”ë° ì´í›„ GPTë¥¼ í†µí•´ JPQLì„ ì´ìš©í•œ ì•„ë˜ ë°©ë²•ì´ ë˜ëŠ”ì§€ í™•ì¸í•´ë´¤ëŠ”ë° ì—­ì‹œ ì•ˆë¨
    - í˜„ì¬ Roomì—ëŠ” ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ê°€ ë˜ì–´ìˆì§€ ì•ŠìŒ
    - ê°ì²´ì™€ SQLë¬¸ì´ ì„ì—¬ ì‚¬ìš©í•˜ë‹¤ë³´ë‹ˆ ë³µì¡í•˜ê¸°ë„ í•¨
- 1:1 ê´€ê³„ì¸ Addressë‚˜ Likes ê°™ì´ ë‹¨ì¼ ê°’ì€ ì²˜ë¦¬í•˜ê¸° ì‰½ì§€ë§Œ, Options, MaintenanceInclude, Imageì™€ ê°™ì€ 1:N ì»¬ë ‰ì…˜ì„ í¬í•¨í•˜ë©´ ë°ì´í„° ì¤‘ë³µ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤ê³  í•¨
- í˜„ì¬ ë‹¨ê±´ì¡°íšŒ ì´ë©° ì¶”ê°€ì ì¸ ì¡°íšŒì¿¼ë¦¬ì— ëŒ€í•´ì„œëŠ” ê°ê°ì˜ ì—”í‹°í‹° ë³„ë„ì˜ Repository ê°€ ë‚˜ë‰˜ì–´ ìˆìœ¼ë‹ˆ ê°ê° ë‹¨ê±´ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ê³  ìƒê°ë˜ì—ˆìŒ. ì´ì „ ë°©ë²•ì„ ê·¸ëŒ€ë¡œ ì´ìš©

```java
// ê¸°ì¡´ ì½”ë“œ
@Transactional(readOnly = true)
public SearchRoomResponseDto searchRoom(Long roomId, Long memberId) {
    var room = findRoom(roomId);
    var address = addressService.findByRoom(room);
    var options = optionService.findByRoom(room);
    var maintenanceIncludes = maintenanceIncludeService.findByRoom(room);
    var images = imageService.findByRoom(room);
    var isLiked = likeRepository.findByRoomAndMemberId(room, memberId)
        .map(Likes::getFlag)
        .orElse(false);

    return RoomConverter.convert(room, isLiked, address, options, maintenanceIncludes, images);
}

// ì´í›„ ê³ ë¯¼ ì½”ë“œ
@Query("""
    SELECT new com.bangjwo.room.application.dto.response.SearchRoomResponseDto(
            r, a, o, m, i)
    FROM Room r
    LEFT JOIN Address a ON a.room = r
    LEFT JOIN Options o ON o.room = r
    LEFT JOIN MaintenanceInclude m ON m.room = r
    LEFT JOIN Image i ON i.room = r
    WHERE r.roomId = :roomId
    """)
Optional<SearchRoomResponseDto> findRoomDetailsByRoomId(Long roomId);

```

<br><br>

### 4-2. ë§¤ë¬¼ ì¡°íšŒ ì‹œ N + 1 ë¬¸ì œ ë°œìƒ
- í˜„ì¬ Pageë¡œ ìƒì„±í•œ ROOM ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì¡°íšŒí•˜ê³  ê° ROOM ì—”í‹°í‹° ë§ˆë‹¤ LIKES, IMAGE ì—”í‹°í‹°ê°€ Në²ˆ(Room ë¦¬ìŠ¤íŠ¸ size ë§Œí¼) ì”© ì¶”ê°€ ì¡°íšŒ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë¨
    - í˜„ì¬ í˜ì´ì§€ë„¤ì´ì…˜ì„ í†µí•´ ì´ page size * 2 ë²ˆ ë§Œí¼ ë°˜ë³µë˜ê³  ìˆìŒ ( 1 + 2N )
- í˜„ì¬ êµ¬ì„±ì€ ROOM ì—”í‹°í‹°ë¥¼ ì¡°íšŒ ì´í›„ LIKES, IMAGE ì—”í‹°í‹° ë‚´ë¶€ì— ROOMì´ ìˆê³ , í•´ë‹¹ ROOMìœ¼ë¡œ LazyLoading ì¡°íšŒë¥¼ í†µí•´ 1 + 2N ì¡°íšŒë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•¨

<br>

```sql
Hibernate: 
    /* <criteria> */ select
        r1_0.room_id,
        r1_0.available_from,
        r1_0.bathroom_cnt,
        r1_0.building_type,
        ...
    from
        room r1_0 
    where
        r1_0.member_id=? 
    limit   /* Pageable ê°ì²´ë§Œí¼ë§Œ ì¡°íšŒ */
        ?
```

- ë³€ê²½ëœ sql í˜ì´ì§€ë„¤ì´ì…˜ ì¡°íšŒ ê²°ê³¼

<br><br>

```sql
Hibernate: 
    /* <criteria> */ select
        r1_0.room_id,
        r1_0.available_from,
        r1_0.bathroom_cnt,
        ...
    from
        room r1_0 
    where
        r1_0.monthly_rent<=? 
        and (
            r1_0.exclusive_area between ? and ? 
            or r1_0.exclusive_area between ? and ? 
            or r1_0.exclusive_area between ? and ?
        ) 
        and r1_0.room_id in ((select
            a1_0.room_id 
        from
            address a1_0 
        where
            a1_0.lat between ? and ? 
            and a1_0.lng between ? and ?)) 
    limit
        ?, ?
Hibernate: 
    /* <criteria> */ select
        l1_0.like_id,
        l1_0.flag,
        ...
    from
        likes l1_0 
    where
        l1_0.room_id=? 
        and l1_0.member_id=?
Hibernate: 
    /* <criteria> */ select
        i1_0.image_id,
        i1_0.created_at,
        ...
    from
        image i1_0 
    where
        i1_0.room_id=? 
    order by
        i1_0.room_id desc 
    limit
        ?
Hibernate: 
    /* <criteria> */ select
        l1_0.like_id,
        l1_0.flag,
        ...
    from
        likes l1_0 
    where
        l1_0.room_id=? 
        and l1_0.member_id=?
Hibernate: 
    /* <criteria> */ select
        i1_0.image_id,
        i1_0.created_at,
        ...
    from
        image i1_0 
    where
        i1_0.room_id=? 
    order by
        i1_0.room_id desc 
    limit
        ?
Hibernate: 
    /* <criteria> */ select
        l1_0.like_id,
        l1_0.flag,
    ......  /*  page ë§Œí¼ ë°˜ë³µ */
```

<br>

### í˜„ì¬ ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ

```java
@Entity
@Table(name = "LIKES") // ...
public class Likes {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long likeId;

    // í˜„ì¬ ë‹¨ë°©í–¥ìœ¼ë¡œ êµ¬ì„±
	@ManyToOne(fetch = FetchType.LAZY)  // ì—°ê´€ê´€ê³„ê°€ Lazyë¡œ ë˜ì–´ìˆì–´ ì‹¤ì œ ì‚¬ìš© ì‹œì ì— ê°ê° ë³„ë„ì˜ ì¡°íšŒ ë°œìƒ
	@JoinColumn(name = "room_id", nullable = false)
	private Room room;
    // ...
}


@Entity
@Table(name = "IMAGE") // ...
public class Image extends BaseEntity {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long imageId;

    // í˜„ì¬ ë‹¨ë°©í–¥ìœ¼ë¡œ êµ¬ì„±
	@ManyToOne(fetch = FetchType.LAZY)  // ì—°ê´€ê´€ê³„ê°€ Lazyë¡œ ë˜ì–´ìˆì–´ ì‹¤ì œ ì‚¬ìš© ì‹œì ì— ê°ê° ë³„ë„ì˜ ì¡°íšŒ ë°œìƒ
	@JoinColumn(name = "room_id", nullable = false)
	private Room room;
    // ...
}

// RoomService searchRooms() ë©”ì„œë“œ
Pageable pageable = PaginationRequest.toPageable(page);
Page<Room> roomPage = roomRepository.findAll(spec, pageable);   // Pageì— ì¼ì¹˜í•˜ëŠ” Room ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ

List<RoomSummaryResponse> roomSummaryList = roomPage.getContent().stream()
    .map(room -> {
        boolean liked = likeRepository.findByRoomIdAndMemberId(room.getRoomId(), memberId)  // Room í•˜ë‚˜ë§ˆë‹¤ Like ì¡°íšŒ
            .map(Likes::getFlag)
            .orElse(false);
        String imageUrl = imageService.findMainImageByRoom(room).getImageUrl(); // Room í•˜ë‚˜ë§ˆë‹¤ Image ì¡°íšŒ
        return RoomConverter.convertToRoomSummary(room, liked, imageUrl);
    })
    .collect(Collectors.toList());
```

### ë¬¸ì œ í•´ê²° ë°©ì‹
- ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ì²«ë²ˆì§¸ ë°©ì‹ì€ Room ì„ 1ë²ˆ ì¡°íšŒí•œ í›„ í•´ë‹¹ ì—”í‹°í‹°ë“¤ì˜ RoomIdë¥¼ ì¶”ì¶œí•˜ì—¬ ë‹¤ë¥¸ ë¦¬ìŠ¤íŠ¸ë¡œ ëª¨ìœ¼ê³  í•´ë‹¹ RoomId ë¦¬ìŠ¤íŠ¸ë¥¼ In ì ˆìœ¼ë¡œ ë°°ì¹˜ ì¡°íšŒ
- ë‘ë²ˆì§¸ ë°©ì‹ì€ Fetch Join ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ Roomê³¼ ì—°ê´€ëœ Likes, Images ì—”í‹°í‹°ë¥¼ í•œ ë²ˆì— ì¡°íšŒ
    - ë¬¼ë¡ , Fetch Joinì„ í•˜ê¸°ìœ„í•´ì„œëŠ” Roomì— ì—°ê´€ ê´€ê³„ë¥¼ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©í•˜ì—¬ì•¼í•¨
    - í•˜ì§€ë§Œ í˜ì´ì§•ê³¼ Fetch Joinì„ í•¨ê»˜ ì‚¬ìš©ì‹œ ê²°ê³¼ í–‰ì´ ì¤‘ë³µë˜ì–´ í˜ì´ì§• ê³„ì‚°ì— ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì–´ DISTINCT ì‚¬ìš© í•„ìš”

<br>

### ì˜ëª»ëœ ì„¤ê³„ë¡œ ë°œìƒí•œ ë¬¸ì œ
- í˜„ì¬ Roomì„ ìƒì„±í•  ë•Œ Address, Image, Options, Likes ë“±ì˜ ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° í•´ë‹¹ ê°ì²´ë“¤ì€ ëª¨ë‘ RoomIdê°€ ë‚´ë¶€ì— ìˆê¸°ì— í•´ë‹¹ í…Œì´ë¸”ì•ˆì— ìœ„ì¹˜í•´ë‘ì—ˆìŒ
- ì´í›„ Address, Image, Options, Likes ë“±ì˜ ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ë•Œ Roomì„ í•œë²ˆì— ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ì¢‹ì€ ìƒê°ì´ì—ˆë‹¤ê³  ìƒê°
- ê·¸ëŸ¬ë‚˜ Roomì„ ì¡°íšŒí•˜ê³  ì´í›„ Roomì— ê´€ë ¨ëœ ê°ì²´ë“¤ì„ ì¡°íšŒí•˜ë ¤ë‹ˆ N + 1 ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒ
- fetch ì¡°ì¸ì„ í•œë‹¤ê³  í•´ê²°í•˜ë ¤ í–ˆì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒ
    - í˜„ì¬ ë‹¨ë°©í–¥ìœ¼ë¡œ ë˜ì–´ìˆì–´ Roomì—ëŠ” ì—°ê´€ ì—”í‹°í‹°ê°€ ì—†ì–´ ì–‘ë°©í–¥ìœ¼ë¡œ ë°”ê¾¸ì§€ ì•Šìœ¼ë©´ Fetch ì¡°ì¸ì´ ë¶ˆê°€ëŠ¥. ì–‘ë°©í–¥ìœ¼ë¡œ ëœë‹¤ê³  í•  ë•Œ ìˆœí™˜ ì°¸ì¡°ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
    - ë˜í•œ Spring Data JPA ê³µì‹ ë¬¸ì„œì— ë”°ë¥´ë©´, í˜ì¹˜ ì¡°ì¸ + í˜ì´ì§•ì€ ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•¨

<br>

### ì—°ê´€ ê´€ê³„ ì •ë¦¬
- Lazy ì—°ê´€ ê´€ê³„ëŠ” ë¶ˆí•„ìš”í•œ ì—”í‹°í‹°ì— ëŒ€í•´ ì§ì ‘ ì¡°íšŒí•˜ê¸° ì „ê¹Œì§€ëŠ” ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ì§€ ì•Šì•„ í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì•ˆì“°ëŠ” í•­ëª©ì´ ìˆìœ¼ë©´ ì¢‹ìŒ. í•˜ì§€ë§Œ ì´í›„ ì“°ê²Œ ëœë‹¤ë©´ ê·¸ ì‹œì ì— ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— ì¶”ê°€ì ì¸ ì¿¼ë¦¬ê°€ ë‚˜ê°€ê²Œ ë¨
- JPQLì—ì„œ JOIN FETCH êµ¬ë¬¸ì„ í†µí•´ ëª…ì‹œì ìœ¼ë¡œ í•„ìš”í•œ ì—”í‹°í‹°ë¥¼ JOINìœ¼ë¡œ í•œêº¼ë²ˆì— ì¡°íšŒí•¨. Lazyë¡œ ì„¤ì •ëœ ê´€ê³„ë¼ë„, í•„ìš”í•œ ì‹œì ì—ë§Œ ë™ì ìœ¼ë¡œ fetch join ê°€ëŠ¥
- [í•´ë‹¹ ë¸”ë¡œê·¸](https://velog.io/@xogml951/JPA-N1-ë¬¸ì œ-í•´ê²°-ì´ì •ë¦¬)ê°€ ì •ë¦¬ê°€ ì˜ë˜ì–´ìˆì–´ ì°¸ì¡°

<br>

### ë°°ì¹˜ ë°©ì‹ìœ¼ë¡œ í•´ê²° ì´ìœ 
- Page ê°ì²´ë¡œ ì„ ì²˜ë¦¬ í–ˆë˜ ê°’ì„ ì‚¬ìš©í•˜ë‹¤ë³´ë‹ˆ Fetch ì¡°ì¸ì€ ì¤‘ë³µ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ + ì–‘ë°©í–¥ìœ¼ë¡œ ë³€ê²½ í•„ìš”í•˜ë¯€ë¡œ, ì²«ë²ˆì§¸ í•´ê²° ë°©ë²•ì¸ ë°°ì¹˜ ë°©ë²•ìœ¼ë¡œ ë¬¸ì œ í•´ê²°
- ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ì´ìœ ëŠ” í•˜ë‚˜ì˜ ë ˆí¬ì§€í† ë¦¬ì—ì„œ ë‹¤ë¥¸ ì—”í‹°í‹°ì— ëŒ€í•œ ì˜ì¡´ì„±ì´ ìƒê¸¸ ìˆ˜ ìˆì–´, ë„ë©”ì¸ ì±…ì„ ë¶„ë¦¬ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ JPQLê³¼ ë°°ì¹˜ ì¡°íšŒ ë°©ì‹ìœ¼ë¡œ í•´ê²° ê²°ì •
    - ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©ì‹œ ë°˜í™˜ íƒ€ì…ì´ Entityê°€ ì•„ë‹ˆë¼ë©´ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬ë˜ì§€ ì•ŠìŒ
    - ex) Room Repositoryì—ì„œ Likes ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•´ë„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê´€ë¦¬ë˜ì§€ë§Œ ë°˜í™˜ íƒ€ì…ì´ ë§ì§€ ì•Šë‹¤ë©´ ê´€ë¦¬ë˜ì§€ ì•ŠìŒ
- ë³€ê²½ëœ ì½”ë“œì™€ ë°œìƒ ì¿¼ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ìŒ
    - ì¶”ê°€ì ìœ¼ë¡œ JPQL ì—ì„œ ì„œë¸Œì¿¼ë¦¬ì—ì„œ ORDER BY, LIMIT ê°™ì€ ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì•„ MAXë¡œ ë³€ê²½

```java
@Transactional(readOnly = true)
public RoomListResponseDto createRoomListResponseDto(
    List<Room> rooms, int totalItems, int page, int size, Long memberId) {
    List<Long> roomIds = rooms.stream()
        .map(Room::getRoomId)
        .toList();

    List<Likes> likes = likeService.getLikeRooms(rooms, memberId);
    Map<Long, Boolean> likeMap = likes.stream()
        .collect(Collectors.toMap(l -> l.getRoom().getRoomId(), Likes::getFlag, (a, b) -> a));

    List<Image> images = imageService.getMainImages(roomIds);
    Map<Long, String> imageMap = images.stream()
        .collect(Collectors.toMap(i -> i.getRoom().getRoomId(), Image::getImageUrl, (a, b) -> a));

    List<RoomSummaryResponse> roomSummaryList = rooms.stream()
        .map(room -> {
            boolean liked = likeMap.getOrDefault(room.getRoomId(), false);
            String imageUrl = imageMap.getOrDefault(room.getRoomId(), null);
            return RoomConverter.convertToRoomSummary(room, liked, imageUrl);
        })
        .toList();

    return new RoomListResponseDto(totalItems, page, size, roomSummaryList);
}

// Image JPQL
@Query("""
        SELECT i
        FROM Image i
        WHERE i.room.roomId IN :roomIds
        AND i.createdAt = (
            SELECT MAX(i2.createdAt)
            FROM Image i2
            WHERE i2.room.roomId = i.room.roomId
        )
    """)
List<Image> findMainImagesByRoomIds(@Param("roomIds") List<Long> roomIds);

// Likes JPQL
@Query("""
        SELECT l
        FROM Likes l
		WHERE l.room IN :rooms AND l.memberId = :memberId
    """)
List<Likes> findByRoomInAndMemberId(@Param("rooms") List<Room> rooms, @Param("memberId") Long memberId);
```

<br>

```java
Hibernate: 
    /* <criteria> */ select
        r1_0.room_id,
        r1_0.available_from,
        ...
    from
        room r1_0 
    where
        r1_0.monthly_rent<=? 
        and (
            r1_0.exclusive_area between ? and ? 
            or r1_0.exclusive_area between ? and ? 
            or r1_0.exclusive_area between ? and ?
        ) 
        and r1_0.room_id in ((select
            a1_0.room_id 
        from
            address a1_0 
        where
            a1_0.lat between ? and ? 
            and a1_0.lng between ? and ?)) 
    limit
        ?, ?
Hibernate: 
    /* SELECT
        l 
    FROM
        Likes l 
    WHERE
        l.room IN :rooms 
        AND l.memberId = :memberId  */
         select
            l1_0.like_id,
            l1_0.member_id,
            l1_0.room_id
            ...
        from
            likes l1_0 
        where
            l1_0.room_id in (?, ?, ?) 
            and l1_0.member_id=?
Hibernate: 
    /*     SELECT
        i     
    FROM
        Image i     
    WHERE
        i.room.roomId IN :roomIds     
        AND i.createdAt = (
            SELECT
                MAX(i2.createdAt)         
            FROM
                Image i2         
            WHERE
                i2.room.roomId = i.room.roomId     
        )  */ 
        select
            i1_0.image_id,
            i1_0.image_url,
            i1_0.room_id,
            ...
        from
            image i1_0 
        where
            i1_0.room_id in (?, ?, ?) 
            and i1_0.created_at=(
                select
                    max(i2_0.created_at) 
                from
                    image i2_0 
                where
                    i2_0.room_id=i1_0.room_id
            )
```

<br><br>

### 4-3. ê³„ì•½ì„œ ì‘ì„± ì‹œ ë™ì‹œì„± ë¬¸ì œ ë°œìƒ
- í˜„ì¬ ê³„ì•½ì„œ ì‘ì„± ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ê³ , í•´ë‹¹ ê³¼ì •ì´ ëë‚˜ì•¼ë§Œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì ‘ê·¼ ê°€ëŠ¥
    1. ê³„ì•½ ì§„í–‰ì— ë”°ë¥¸ ê³„ì•½ì„œ ìƒì„±
    2. ì„ëŒ€ì¸ ê³„ì•½ì„œ ì €ì¥
    3. ì„ì°¨ì¸ ê³„ì•½ì„œ ì €ì¥
    4. ì‘ì„±ëœ ê³„ì•½ì„œë¥¼ ê°ì ìµœì¢… ì¡°íšŒ í›„ ìˆ˜ì •
    5. ì„ì°¨ì¸ ì„œëª…
    6. ì„ëŒ€ì¸ ì„œëª…
    7. ê³„ì•½ ìµœì¢… ì™„ë£Œ
- í•´ë‹¹ ê³¼ì •ì— ìˆì–´ ì„ì°¨ì¸ ì„œëª…í•˜ëŠ” ë™ì•ˆ ì„ëŒ€ì¸ì´ ê³„ì•½ì„œë¥¼ ìˆ˜ì •í•˜ê³  ìˆëŠ” ê²½ìš°ê°€ ì¡´ì¬í•˜ê³ , ì„ì°¨ì¸ì´ ì„œëª… ì™„ë£Œí•˜ëŠ” ì‹œì ì— ë´¤ì—ˆë˜ ê³„ì•½ì„œ ë‚´ìš©ê³¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
- ì´ì— ìˆì–´ ì„ëŒ€ì¸ì´ 3ë²ˆ ì´í›„ ê³„ì•½ì„œë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ 5ë²ˆì—ì„œ ì„ì°¨ì¸ì´ ì„œëª…í•˜ëŠ” ê²½ìš°ë¥¼ Redis ë½ì„ í†µí•´ ì ‘ê·¼í•˜ë„ë¡ ë³€ê²½ ì˜ˆì •
- í¼ì‚¬ë“œ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ ë¡œì§ ì´ì „ì— ë½ì„ í™•ì¸í•˜ê³  ì ‘ê·¼í•˜ë„ë¡ ìˆ˜ì • ì˜ˆì •

<br>

### ë¬¸ì œ í•´ê²° ë°©ë²•ìœ¼ë¡œ Redis ë‹¨ìˆœ ë½ìœ¼ë¡œ ì‚¬ìš©í•œ ì´ìœ 
- ë°©ë²•ìœ¼ë¡œëŠ” ë‹¤ì–‘í•œ ë°©ë²•ë“¤ì´ ì¡´ì¬í–ˆëŠ”ë° JVM ë‚´ë¶€ ë½(synchronized, ReentrantLock), ìŠ¤í•€ë½, Redission ë¶„ì‚°ë½, DB ë‚™ê´€ì /ë¹„ê´€ì  ë½ ë“±ì´ ì¡´ì¬
- ìš°ì„  Redisë¥¼ ì‚¬ìš©í•œ ê°„ë‹¨í•œ ë½ìœ¼ë¡œ êµ¬í˜„í•˜ê¸°ë¡œ ê²°ì •í–ˆëŠ”ë° ì´ìœ ëŠ” ì•„ë˜ë“¤ê³¼ ê°™ìŒ
    - ê³„ì•½ì„œ ë½ ìë™ í•´ì œëŠ” TTL ê¸°ë°˜ìœ¼ë¡œ, ì¸ë©”ëª¨ë¦¬ DBë¥¼ ì‚¬ìš©í•œ Redis ë‹¨ìˆœ ë½ ë°©ì‹ìœ¼ë¡œ ê²°ì •
    - í˜„ì¬ ì±„íŒ… ê´€ë ¨ìœ¼ë¡œ Redisë¥¼ ì´ë¯¸ ì‚¬ìš©í•˜ê³  ìˆìŒ
- ìŠ¤ë ˆë“œì˜ ë¹„ì •ìƒì ì¸ ì¢…ë£Œì— ëŒ€ë¹„í•˜ì—¬ ìë™ìœ¼ë¡œ ë½ì„ í•´ì œí•˜ëŠ” ë°©ë²•ì´ í•„ìš”. ì´ì— ëŒ€í•´ ìŠ¤í•€ë½ê°™ì€ í•˜íŠ¸ë¹„íŠ¸ ë°©ì‹ì€ ë¶ˆí•„ìš”í•œ CPUë¥¼ ì ìœ  ë°œìƒ
- í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” ëª¨ë†€ë¦¬ì‹ êµ¬ì¡°ë¡œ ë¶„ì‚° í™˜ê²½ì„ ê³ ë ¤í•  í•„ìš”ëŠ” ì—†ì§€ë§Œ, ì´í›„ MSAë¡œ í™•ì¥ ê°€ëŠ¥í•œ í˜•íƒœë¡œëŠ” êµ¬ì„±í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤ê³  íŒë‹¨
- ë¬¼ë¦¬ DBë¥¼ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ê³¼ì •ì´ ë¶ˆí•„ìš”í•œ I/O ì—°ì‚°ì´ë‚˜ ë³‘ëª©ì„ ì¶”ê°€í•œë‹¤ê³  íŒë‹¨
- Redission ì€ TTL ìë™ ì—°ì¥ ê°™ì€ ì—¬ëŸ¬ ê¸°ëŠ¥ì´ ì¡´ì¬í•˜ì§€ë§Œ í˜„ì¬ ë½ ìš”êµ¬ ìˆ˜ì¤€ì—ì„œëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë„ì…ì´ ê³¼ë„í•˜ë‹¤ê³  íŒë‹¨í•˜ì—¬ ìš°ì„ ìˆœìœ„ì—ì„œ ì œì™¸

<br>

### í•´ê²° ì½”ë“œ

```java
// ì„ëŒ€ì¸ ê³„ì•½ì„œ ìˆ˜ì • ë©”ì„œë“œ
@Transactional
@RedisLock(key = "'contract:' + #requestDto.contractId", errorCode = RedisLockErrorCode.TENANT_IN_PROGRESS)
public void finalLandlordAfterTenant(UpdateLandlordInfoDto requestDto, Long memberId) {
    // ...
}

// ì„ì°¨ì¸ ê³„ì•½ì„œ ì„œëª… ë©”ì„œë“œ
@Transactional
@RedisLock(key = "'contract:' + #requestDto.contractId", errorCode = RedisLockErrorCode.LANDLORD_IN_PROGRESS)
public void updateTenantSignature(TenantSignatureUpdateRequestDto requestDto, Long memberId) {
    // ...
}

// RedisLock ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RedisLock {
	String key();
	long leaseTime() default 1800;
	RedisLockErrorCode errorCode() default RedisLockErrorCode.LOCKED_RESOURCE;
}

// Redis AOP 
@Slf4j
@Aspect
@Component
@RequiredArgsConstructor
public class RedisLockAspect {
	private final StringRedisTemplate redisTemplate;

    // ë½ì˜ ì†Œìœ ìë§Œ ë½ì„ í’€ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•œ Redis Lua ìŠ¤í¬ë¦½íŠ¸
	private static final String UNLOCK_SCRIPT =
		"if redis.call('get', KEYS[1]) == ARGV[1] then " +
			"   return redis.call('del', KEYS[1]) " +
			"else " +
			"   return 0 " +
			"end";

	@Around("@annotation(redisLock)")
	public Object around(ProceedingJoinPoint joinPoint, RedisLock redisLock) throws Throwable {
		String key = parseKey(redisLock.key(), joinPoint);
		long leaseTime = redisLock.leaseTime();

		String uuid = UUID.randomUUID().toString();

        // setIfAbsentë¥¼ ì‚¬ìš©í•˜ë©´ RedisClient ë‚´ë¶€ì ìœ¼ë¡œ SENTX êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥
		Boolean success = redisTemplate
			.opsForValue()
			.setIfAbsent(key, uuid, leaseTime, TimeUnit.SECONDS);

		if (Boolean.FALSE.equals(success)) {
			throw new BusinessException(redisLock.errorCode());
		}

		try {
			return joinPoint.proceed();
		} finally {
			releaseLock(key, uuid);
		}
	}

    // ë½ í•´ì œ
	private void releaseLock(String key, String uuid) {
		redisTemplate.execute(
			new DefaultRedisScript<>(UNLOCK_SCRIPT, Long.class),
			List.of(key),
			uuid
		);
	}

    // 
	private String parseKey(String keyExpression, ProceedingJoinPoint joinPoint) {
		MethodSignature signature = (MethodSignature)joinPoint.getSignature();

		EvaluationContext context = new StandardEvaluationContext();
		String[] parameterNames = signature.getParameterNames();
		Object[] args = joinPoint.getArgs();

		for (int i = 0; i < parameterNames.length; i++) {
			context.setVariable(parameterNames[i], args[i]);
		}

		ExpressionParser parser = new SpelExpressionParser();
		return parser.parseExpression(keyExpression).getValue(context, String.class);
	}
}
```
- AOP ë° í¼ì‚¬ë“œ íŒ¨í„´ì„ í™œìš©í•œ Redis ë‹¨ìˆœ ë½ êµ¬í˜„
- Lock ì¡°íšŒì—ì„œ setIfAbsent() ëª…ë ¹ì€, Redis ë‚´ë¶€ì ìœ¼ë¡œ SENTXë¥¼ í™œìš©í•˜ì—¬ ë‹¨ì¼ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥
- Lock KeyëŠ” SpELì„ í†µí•´ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ì–´, 'contract: {contractId}' í˜•ì‹ìœ¼ë¡œ Keyë¥¼ ì§€ì •
- ë¶ˆê°€í”¼í•˜ê²Œ ì„œë²„ê°€ ì¢…ë£Œë˜ë”ë¼ë„ TTL ì´í›„ ë½ì´ í•´ì œê°€ ë˜ê³ , 30ë¶„ê°„ 2ëª…ë§Œì´ ì‚¬ìš©í•˜ëŠ” ê³„ì•½ì„œì— ì ‘ê·¼ ëª»í•˜ëŠ” ê²ƒì€ í° ë¬¸ì œê°€ ì•„ë‹ˆë¼ê³  íŒë‹¨
- ë˜í•œ, ì„œë²„ê°€ ì ì‹œ ì¤‘ë‹¨ë˜ê³  ë‹¤ì‹œ ì‹¤í–‰ë˜ì—ˆì„ ë•Œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë½ì„ ë‹¤ì‹œ ê°€ì§€ê³  ìˆì§€ë§Œ ì„œë²„ê°€ ì¤‘ë‹¨ë˜ëŠ” ì‹œì ì— ì¤‘ì§€ë¬ë˜ ìŠ¤ë ˆë“œê°€ ë‹¤ì‹œ ë™ì‘í•˜ì—¬ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ê°€ì§€ê³  ìˆëŠ” ë½ì„ í•´ì œí•˜ëŠ” ê²½ìš°ë¥¼ ë§‰ê¸° ìœ„í•´ Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œìš©í•´ ë½ ì†Œìœ ìë§Œ ë½ì„ í•´ì œí•  ìˆ˜ ìˆë„ë¡ ì§€ì •

<br>

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•œ ë™ì‹œì„± ë¬¸ì œ í•´ê²° í™•ì¸

![ë™ì‹œì„± í•´ê²° í…ŒìŠ¤íŠ¸ ì½”ë“œ](./img/concurreny-test.gif)

```java
@Test
void testConcurrentRedisLock() throws InterruptedException {
    int threadCount = 20;
    ExecutorService executorService = Executors.newFixedThreadPool(threadCount);
    CountDownLatch startLatch = new CountDownLatch(1);
    CountDownLatch doneLatch = new CountDownLatch(threadCount);
    AtomicInteger successCount = new AtomicInteger(0);
    AtomicInteger failCount = new AtomicInteger(0);

    for (int i = 0; i < threadCount; i++) {
        executorService.submit(() -> {
            try {
                TenantSignatureUpdateRequestDto dto = new TenantSignatureUpdateRequestDto();
                dto.setContractId(1L);
                MultipartFile file = mock(MultipartFile.class);
                given(file.getBytes()).willReturn("mock-content".getBytes());
                dto.setSignature(file);

                startLatch.await(); // CountDownLatchë¥¼ í™œìš©í•˜ì—¬ ìŠ¤ë ˆë“œ ë™ì‹œ ë™ì‘
                contractService.updateTenantSignature(dto, 999L);
                successCount.incrementAndGet();
            } catch (BusinessException e) {
                failCount.incrementAndGet();
                System.out.println("[FAIL] " + e.getErrorCode().getCode());
            } catch (Exception e) {
                failCount.incrementAndGet();
                e.printStackTrace();
            } finally {
                doneLatch.countDown();
            }
        });
    }

    startLatch.countDown(); // ì¼ì œíˆ ì¶œë°œ
    doneLatch.await(); // ëª¨ë‘ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    executorService.shutdown();

    System.out.println("ì„±ê³µ: " + successCount.get());
    System.out.println("ì‹¤íŒ¨: " + failCount.get());

    assertEquals(1, successCount.get(), "ì„±ê³µí•œ ìŠ¤ë ˆë“œëŠ” ì •í™•íˆ 1ê°œì—¬ì•¼ í•©ë‹ˆë‹¤");
    assertEquals(threadCount - 1, failCount.get(), "ë‚˜ë¨¸ì§€ ìŠ¤ë ˆë“œëŠ” ë½ ì—ëŸ¬ê°€ ë°œìƒí•´ì•¼ í•©ë‹ˆë‹¤");
}
```

<br>

![ë™ì‹œì„± í…ŒìŠ¤íŠ¸](./img/concurrency-test.png)

- í•´ë‹¹ ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ë¥¼ ë³´ë©´ ìŠ¤ë ˆë“œ ë™ì‘ ì‹œì ì€ T13:43:58.595 ~ T13:43:58.596 ìœ¼ë¡œ ë™ì‹œì— ì‹œë„
- í•´ë‹¹ íŒŒë€ìƒ‰ í…Œë‘ë¦¬ë¥¼ ë³´ë©´ ë‹¤ì–‘í•œ ìŠ¤ë ˆë“œê°€ ë™ì‘í•œë‹¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŒ

```
// í…ŒìŠ¤íŠ¸ ì„±ê³µ
ì„±ê³µ: 1
ì‹¤íŒ¨: 19
```

<br>

### í…ŒìŠ¤íŠ¸ ì½”ë“œ Jenkins ë¹Œë“œ ì¤‘ ë¬¸ì œ ë°œìƒ
- í˜„ì¬ Jenkins ë¹Œë“œì—ì„œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë™ì‘ì— ìˆì–´ Docker ë‚´ë¶€ì— ìˆëŠ” MySQL ì— ì ‘ê·¼í•˜ëŠ”ë° ë¬¸ì œ ë°œìƒ
- ì´ì— ìˆì–´ ê¸°ì¡´ clean buildë¥¼ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì œì™¸í•˜ê³  ì‹¤í–‰í•˜ëŠ” clean build -x test ë¡œ ë¹Œë“œ ëª…ë ¹ì–´ ìˆ˜ì •

<br>

<br>

## 5. í™”ë©´ êµ¬ì„±

### 1. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸

![ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸](./img/login.gif)

<br>

### 2. ë§¤ë¬¼ ë“±ë¡

![ì„ëŒ€ì¸ ë§¤ë¬¼ ì •ë³´ ë“±ë¡](./img/room-input-info.gif)

![ë“±ë¡ ë§¤ë¬¼ ê²€ì¦](./img/room-verify.gif)

<br>

### 3. ë§¤ë¬¼ ì¡°íšŒ ë° ë“±ê¸°ë¶€ë“±ë³¸ ìœ„í—˜ë„ ë¶„ì„

![ë§¤ë¬¼ ì¡°íšŒ](./img/contract-risk.gif)

<br>

### 4. ë¬¸ì˜ ì±„íŒ…

![ê³„ì•½ ë¬¸ì˜ ì±„íŒ…](./img/chat.gif)

<br>

### 5. ê³„ì•½ì„œ ì‘ì„±

![ì„ëŒ€ì¸ ê³„ì•½ì„œ ì‘ì„±](./img/landlord-contract.gif)

<br>

### 6. ê³„ì•½ì„œ ì±—ë´‡

![ê³„ì•½ì„œ ì±—ë´‡](./img/AIchatbot.gif)

<br>