# Docker

### 가상화와 컨테이너
#### 가상화
- 가상화는 하나의 하드웨어를 여러 개의 가상 머신으로 분할해 효율적으로 사용할 수 있는 기술이고 분할된 가상 머신들은 각각 독립적인 환경으로 구동되는데 이때 베이스가 되는 기존의 환경을 Host OS, 그리고 가상 머신으로 분할된 각각의 환경을 Guest OS라고 부름
- 가상 머신을 생성하기 위해서는 하이퍼바이저 또는 가상 머신 모니터라고 불리는 소프트웨어를 이용
- 하이퍼바이저는 호스트 하드웨어에 설치되어 호스트와 게스트를 나누는 역할을 하고, 각각의 게스트는 하이퍼바이저에 의해 관리되며 시스템 자원을 할당받게 됨
- 이때 하이퍼바이저에 의해 생성된 게스트는 호스트나 다른 게스트와 상호 간섭하지 않고 완전히 분리된 환경에서 구동됨
- 하이퍼바이저를 활용하면 마치 하드웨어가 여러 개인 것처럼 하나의 서버를 여러 명이 나눠쓸 수도 있고, 컴퓨터 한 대에서 서로 다른 OS를 동시에 사용할 수도 있음
- 가상 머신으로 동작을 시키려면 반드시 하이퍼바이저를 거쳐야하기 때문에 속도 저하가 필연적이고 또 가상 머신은 해당 환경을 구동하는데 필요한 파일을 모두 포함하고 있기 때문에 가상 머신을 배포할 때 만들어지는 이미지의 크기가 매우 커진다는 한계점이 있음

```
하이퍼 바이저(Hypervisor)란
- 하이퍼바이저는 하나의 컴퓨터(서버)에서 여러 운영체제를 동시에 실행할 수 있게 해주는 소프트웨어
- 컴퓨터에 하이퍼바이저를 설치하면, 이 하이퍼바이저는 컴퓨터의 하드웨어 자원(CPU, 메모리, 디스크)을 여러 개의 가상머신(VM)으로 나누어줌
- 각 가상머신은 독립적인 운영체제를 실행할 수 있어, 한 컴퓨터에서 Windows와 Linux 두 개의 운영체제를 동시에 사용할 수 있게 함. 두 운영체제는 마치 각각의 독립된 컴퓨터에서 동작하는 것처럼 보임
```

<br>

#### 컨테이너
- 컨테이너란 하나의 운영 체제 커널에서 다른 프로세스에 영향을 받지 않고 독립적으로 실행되는 프로세스 상태
- 컨테이너는 가상의 OS를 만드는 것이 아니라 베이스 환경의 OS를 공유하면서 필요한 프로세스만 격리하는 방식으로 커널을 공유하기 때문에 호스트 OS의 기능을 모두 사용할 수 있음
    - 우리가 사용할 OS를 가상화하지 않고 단순히 프로세스를 격리하여 호스트 입장에서는 단순히 프로세스가 실행되는 것으로 보이고 필요만 만큼만 CPU나 메모리가 사용되어 훨씬 빠르고 효율적
    - 그렇기 때문에 컨테이너 위에서는 호스트 OS와 다른 OS를 구동할 수 없음
- 대신 격리시킬 애플리케이션과 거기에 필요한 파일이나 특정 라이브러리 등 종속 항목만 포함하기 때문에 배포를 위해 생성되는 이미지의 용량이 작아지는 장점이 있음
- 운영체제가 아닌 프로세스이며 하이퍼바이저를 거칠 필요가 없어 실행 속도가 빠름

```
가상화 상태의 프로세스 == 컨테이너?

- 가상화 상태의 프로세스가 모두 컨테이너는 아님
- 가상화 상태라는 것은 하드웨어나 운영체제를 가상화한 상태를 의미할 수 있는데 그 방식에 따라 가상 머신일 수도 있고 컨테이너일 수도 있음

가상 머신에서 실행되는 프로세스
- 이는 하드웨어 가상화의 일환으로 독립된 운영체제를 포함한 가상 머신 내에서 실행되는 프로세스

컨테이너에서 실행되는 프로세스
- 운영체제의 가상화로 같은 운영체제 커널을 공유하면서 독립적으로 실행되는 프로세스
```

<br>

### 가상화 vs 가상머신

<br>

| **구분**            | **가상화(Virtualization)**                                                                 | **가상머신(Virtual Machine, VM)**                                                  |
|---------------------|-------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------|
| **정의**            | 물리적 자원을 논리적으로 분리하여 여러 환경에서 사용할 수 있도록 하는 기술.                | 하이퍼바이저를 통해 가상화된 환경에서 **독립된 운영체제**를 실행하는 시스템.        |
| **구현 방식**       | 하이퍼바이저, 컨테이너 등을 통해 물리적 하드웨어를 가상 자원으로 분리.                     | 물리적 하드웨어 위에 **하이퍼바이저**를 통해 여러 가상 운영체제를 실행.             |
| **운영체제**        | 운영체제를 공유하거나, 하나의 호스트 운영체제 위에서 여러 애플리케이션을 실행.              | 각 가상머신은 **독립적인 운영체제**를 실행하며, 서로 완전히 격리됨.                |
| **리소스 소비**     | 경량화된 방식으로, 특히 **컨테이너**를 사용하면 적은 리소스를 소모.                       | 각 가상머신은 **전체 운영체제를 포함**하므로 더 많은 리소스가 필요.                 |
| **속도**            | 운영체제 수준에서 가상화를 구현하므로 **빠른 성능** 제공.                                   | 가상머신은 하이퍼바이저를 거치므로 **상대적으로 느림**.                             |
| **격리성**          | 운영체제 커널을 공유하므로 완벽한 격리는 아니지만, 네임스페이스와 cgroups로 격리 가능.      | 각 가상머신이 독립된 운영체제와 커널을 사용하여 **완벽한 격리**를 보장.             |
| **대표 기술**       | Docker, LXC, KVM (컨테이너 방식의 가상화).                                                  | VMware, VirtualBox, Hyper-V (하이퍼바이저 기반의 가상머신).                        |


#### 이미지
- 가상 머신이나 컨테이너 또는 프로그램을 실행하는 데 필요한 파일과 라이브러리, 설정 등을 가지고 있는 파일
- 이미지는 레이어라는 계층 구조로 이루어져 있는데 변경 사항이 생기면 새로운 레이어를 추가해서 기록
- 이미지 전체를 새로 받지 않고 해당 레이어만 받는 것으로 이미지를 업데이트할 수 있는 장점이 있음
- 이미지를 실행하면 프로세스, 즉 컨테이너가 됨

<br>

### 컨테이너 인프라 환경
- 기존 엔지니어가 개발 환경을 제공하면 사용자는 그에 맞는 도구를 모두 설치해야 했던 온프레미스(on-premises) 환경은 고전적인 환경이 됨
- 최근에는 이미 구성된 환경을 사용자 필요에 따라 선택하고 조합해서 사용할 수 있게 제공되는 서비스로서의 인프라 환경(IaaS, Infrastructure as a Service)가 됨
- 빠르게 개발환경을 구축하고 예정된 목표를 달성하기 위한 애자일 개발 방법론에 만족하는 컨테이너 인프라 환경이 대두됨
- 컨테이너 인프라 환경은 컨테이너를 중심으로 구성된 인프라 환경

<br>

### 모놀리식 아키텍처 (monolithic architecture)
- 모놀리식 아키텍처는 하나의 큰 목적이 있는 서비스 또는 애플리케이션에 여러 기능이 통합돼 있는 구조를 의미
- 모놀리식에서는 소프트웨어가 하나의 결합된 코드로 구성되어 초기 단계에서 설계하기 용이하며 개발이 단순하고 코드 관리가 간편함
- 하지만 서비스를 운영하는 과정에서 수정이 많을 경우 연관된 다른 서비스에 영향을 미칠 가능성이 커지고 서비스가 성장할수록 서비스 간의 관계가 매우 복잡해짐
- 뉴스, 카페, 웹툰, 결제 등의 서비스가 하나의 애플리케이션 안에 있다면 보안이나 데이터베이스 접속 등 공통 설정을 사용하면 개발 속도는 빠르겠지만 하나의 서비스의 사용량이 급증할 경우 다른 서비스를 확장하는 것은 매우 비효율적
- 하나의 서비스에서 예기치 못한 에러가 발생했다면 전체 서비스를 이용할 수 없는 상황이 생길 수 있음

<br>

### 마이크로서비스 아키텍처 (MSA, Microservices Architecture)
- 마이크로서비스 아키텍처는 개별 기능을 하는 작은 서비스를 각각 개발해 연결하는 구조
- 보안, 인증 등과 관련된 기능이 독립된 서비스를 구성하고 있으며 다른 서비스들도 독립적으로 동작할 수 있는 완결된 구조
- 해당 구조는 개발된 서비스를 재사용하기 쉽고, 이후 서비스가 변경되어도 다른 서비스에 영향을 미칠 가능성이 줄어듬
- 사용자의 요구사항에 따라 가용성을 즉각적으로 확보해야 하는 IaaS 환경에 적합
- 하지만 모놀리식 아키텍처보다 복잡도가 높으며 각 서비스가 유기적으로 통신하는 구조로 설계되어 네트워크를 통한 호출 횟수가 증가해 성능에 영향을 줄 수 있음
    - 주로 각 서비스는 API 게이트웨이와 REST API를 통한 통신
- 이러한 마이크로 서비스는 컨테이너 인프라 환경에서 제공하는 컨테이너를 서비스 단위로 포장해 쉽게 배포하고 확장할 수 있어 컨테이너 인프라 환경 구성에 적합함
    - 컨테이너 인프라 환경에서 제공하는 컨테이너는 마이크로 아키텍처 서비스와 1:1로 완벽하게 대응

<br>

### Docker
- 컨테이너 기술을 기반으로 한 일종의 가상화 플랫폼
- 가상화란 물리적 자원인 하드웨어를 효율적으로 활용하기 위해서 하드웨어 공간 위에 가상의 머신을 만드는 기술이고 컨테이너란 컨테이너가 실행되고 있는 호스트 OS의 기능을 그대로 사용하면서 프로세스를 격리해 독립된 환경을 만드는 기술
- 독립된 환경을 만들어서 하드웨어를 효율적으로 활용하는 기술
    - 컨테이너를 잘 다룰 수 있도록 도와주는 도구
    - 도커를 이용하여 쉽게 이미지를 실행시켜 컨테이너로 만들거나, 생성된 컨테이너를 관리하거나 컨테이너를 다시 이미지로 만드는 작업을 쉽게 할 수 있음
    - 개발 과정에서 다른 라이브러리와 충돌하는 것을 방지하기 위해 격리된 환경이 필요할 때, 완성된 서비스를 배포할 때, 혹은 배포 중인 서비스를 받아서 실행해볼 때도 유용

<br>

### 도커를 사용하는 이유
- 컨테이너 기반 오픈소스 가상화 플랫폼으로 다양한 이유로 계속 바뀌는 서버환경과 개발 환경 문제를 해결하기 위해 등장
- 도커 허브에 올라온 이미지와 docker-compose.yml의 설정으로 원하는 프로그램을 편안하게 설치/제거가 가능
- 하나의 서버에 포트만 변경하여 동일한 프로그램을 실행하기도 쉬워서 환경변수나 경로등의 충돌을 신경쓰지 않아도됨
- 서로 다른 프로그램이더라도 컨테이너로 규격화되어있어 컨테이너로 만들 수 있고 어떤 환경에서도 돌아감
- 가상머신과 비슷하게 생각할 수 있으나 가상머신보다 빠르고 쉽고 효율적임. 도커는 컴퓨터 자원을 그대로 사용하고 가상머신은 독립된 메모리를 할당받음

<br>

### 도커의 특징
- 확장성과 이식성
    - 도커가 설치되어 있다면 어디서든 컨테이너를 실행할 수 있음
    - 오픈 소스이기에 특정 회사나 서비스에 종속적이지 않음
    - 쉽게 개발서버를 만들 수 있고 테스트 서버 생성도 가능
- 표준성
    - 도커를 사용하지 않는 경우, 각각의 언어로 만든 서비스들의 배포 방식은 모두 다름
    - 도커는 컨테이너라는 표준으로 서버를 배포하므로 모든 서비스들의 배포 과정이 동일해짐
- 이미지
    - 컨테이너를 실행하기 위한 압축파일과 같은 개념
    - 이미지에서 컨테이너를 생성하기 떄문에 반드시 이미지를 만드는 과정이 필요
    - Dockerfile을 이용하여 이미지를 만들고 처음부터 재현 가능
    - 빌드 서버에서 이미지를 만들면 해당 이미지를 이미지 저장소(허브)에 저장하고 운영서버에서 이미지를 불러와 사용
- 설정관리
    - 도커에서 설정은 보통 아래와 같이 환경변수로 제어
    - MYSQL_PASS=password와 같이 컨테이너를 띄울 때 환경변수를 같이 지정
    - 하나의 이미지가 환경변수에 따라 동적으로 설정파일을 생성하도록 만들어져야함
- 자원관리
    - 컨테이너는 삭제 후 새로 만들면 모든 데이터가 초기화됨 (제거가 쉬움)
    - 그러므로 저장이 필요하다면, 업로드 파일을 외부 스토리지와 링크하여 사용하거나 S3같은 별도의 저장소가 필요
    - 세션이나 캐시를 memcached나 redis와 같은 외부로 분리

<br>

## Ssafy Wizards CS Study

<br>

### 1. 가상화가 무엇이고, 이것이 가상머신과 어떠한 차이가 있는지
#### 가상화
- 가상화는 물리적인 하드웨어 자원을 소프트웨어적으로 분리하여, 여러 개의 독립된 환경을 구축할 수 있도록 하는 기술
- 가상화를 통해 하나의 물리적 시스템에서 여러 개의 운영체제 또는 애플리케이션을 동시에 실행할 수 있음
- 가상화는 주로 서버 가상화, 네트워크 가상화, 스토리지 가상화로 나눌 수 있으며, 가장 일반적인 형태는 하이퍼바이저(hypervisor)를 사용하여 여러 운영체제를 동시에 실행하는 서버 가상화임

#### 가상머신
- 가상머신(Virtual Machine, VM)은 가상화의 한 예로, 물리적인 하드웨어 위에 하이퍼바이저를 통해 여러 개의 독립적인 운영체제를 실행하는 환경

<br>

### 2. 그렇다면 Docker는 둘 중 어디에 속하는지 및 왜 사람들이 Docker를 많이 채택하는지
- Docker는 컨테이너(Container) 기술을 사용하며, 전통적인 가상머신(VM)과 다른 가상화의 한 형태
- 운영체제 수준의 가상화에 해당하여 하나의 운영체제 커널 위에서 여러 개의 독립적인 애플리케이션 환경을 실행할 수 있음
- Docker는 하이퍼바이저를 사용하는 가상머신과 달리, 컨테이너를 통해 가볍고 빠른 실행 환경을 제공
- Docker 컨테이너는 각각의 애플리케이션과 그에 필요한 모든 라이브러리, 의존성을 포함한 패키지로 실행되지만, 운영체제 커널을 공유함

#### Docker 채택 이유
- 경량성
    - Docker는 가상머신보다 리소스 소비가 적고 빠르게 실행 가능
    - 가상머신은 하나의 운영체제 전체를 실행하지만, Docker는 하나의 운영체제 커널을 공유하므로 훨씬 경량화되어 있음
- 빠른 배포
    - Docker 이미지를 통해 애플리케이션을 한 번 패키징하여 어디서든 실행 가능
- 이식성
    - Docker 컨테이너는 개발 환경과 운영 환경 간 차이를 최소화하여, 어디서나 동일하게 동작
- 확장성 및 관리 용이성
    - Kubernetes와 같은 오케스트레이션 도구와 결합하여 컨테이너의 확장과 관리가 용이

<br>

### 3. 하나의 Host OS에서 돌아간다면 충분히 한 컨테이너가 다른 컨테이너에 간섭할 수 있는 위험이 있지 않는지? 이를 어떻게 방어할 수 있을지
- 하나의 Host OS에서 여러 컨테이너가 실행될 때, 한 컨테이너가 다른 컨테이너를 간섭할 위험이 있을 수 있음
- Docker 에서는 리눅스 네임스페이스와 Cgroups를 등을 통해 컨테이너 간 격리와 자원 제한을 관리하여 간섭을 방지함

#### 방어방법
- 네임스페이스(Namespaces)
    - 각 컨테이너의 프로세스, 네트워크, 파일 시스템 등을 독립적으로 격리하여 다른 컨테이너와 자원을 공유하지 않도록 함
- Cgroups(Control Groups)
    - 각 컨테이너가 사용하는 CPU, 메모리, 디스크 I/O 같은 리소스 사용량을 제한해 다른 컨테이너에 영향을 주지 않도록 관리

<br>

### 4. Docker 위에 Docker를 올릴 순 없는지
- Docker in Docker (DinD)는 가능. Docker 컨테이너 내부에서 다른 Docker 인스턴스를 실행하는 것을 의미
- 이를 구현할 수 있지만, 보안 이슈 및 성능 저하 등의 이유로 권장되지 않는 방식
    -  Docker 컨테이너는 가볍고 독립적이지만, DinD는 복잡성을 더하며, 컨테이너 간의 경계가 모호해질 수 있기 때문
- Kubernetes나 Docker Swarm 등의 오케스트레이션 도구를 통해 다중 컨테이너 환경을 효율적으로 관리하는 것이 더 일반적
    - 오케스트레이션 도구란 여러 컨테이너를 관리하는 작업을 자동화하는 도구로 컨테이너의 배포, 네트워킹, 확장, 업데이트, 장애 복구 등을 자동으로 수행
    - 컨테이너가 개별적으로 잘 동작하더라도, 여러 개의 컨테이너를 대규모로 운영할 때는 자동화된 관리가 필요하여 오케스트레이션 도구를 사용

<br>

<div style="text-align: right">22-10-10</div>

-------

## Reference
- https://velog.io/@markany/도커에-대한-어떤-것-1.-도커란-무엇인가
- https://wooody92.github.io/docker/Docker-도커란-무엇인가/